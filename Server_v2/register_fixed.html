<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ladabot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .online-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .bot-online { background-color: #28a745; }
        .bot-offline { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <!-- Авторизация -->
        <div id="auth-container" class="row justify-content-center">
            <div class="col-md-4">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fa fa-sign-in"></i> Ladabot Dashboard</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">License Key</label>
                            <input type="text" id="license-input" class="form-control" 
                                   placeholder="Введите license key" value="TEST-123">
                            <small class="text-muted">Используйте ключ, который отправляет бот</small>
                        </div>
                        <button class="btn btn-primary w-100" onclick="login()">
                            <i class="fa fa-sign-in"></i> Войти
                        </button>
                        <div class="alert alert-danger mt-2 d-none" id="login-error"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Основная панель -->
        <div id="dashboard-container" class="d-none">
            <!-- Навигация -->
            <nav class="navbar navbar-dark bg-dark mb-4">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">
                        <i class="fa fa-robot"></i> Ladabot Dashboard
                    </a>
                    <div class="text-white">
                        License: <span id="current-license"></span>
                        <button class="btn btn-outline-light btn-sm ms-3" onclick="logout()">
                            <i class="fa fa-sign-out"></i> Выйти
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Статистика -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stat-card bg-primary text-white">
                        <div class="card-body">
                            <h6 class="card-title">Всего аккаунтов</h6>
                            <h2 id="stat-accounts" class="mb-0">0</h2>
                            <small><i class="fa fa-user"></i> всего</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card bg-success text-white">
                        <div class="card-body">
                            <h6 class="card-title">Сообщений</h6>
                            <h2 id="stat-messages" class="mb-0">0</h2>
                            <small><i class="fa fa-envelope"></i> отправлено</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card bg-info text-white">
                        <div class="card-body">
                            <h6 class="card-title">Ответов</h6>
                            <h2 id="stat-responses" class="mb-0">0</h2>
                            <small><i class="fa fa-reply"></i> получено</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card bg-warning text-white">
                        <div class="card-body">
                            <h6 class="card-title">Конверсия</h6>
                            <h2 id="stat-conversion" class="mb-0">0%</h2>
                            <small><i class="fa fa-percentage"></i> эффективность</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Аккаунты -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fa fa-list"></i> Аккаунты</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Логин</th>
                                    <th>Статус</th>
                                    <th>Режим</th>
                                    <th>Цель</th>
                                    <th>Сообщений</th>
                                    <th>Ответов</th>
                                    <th>Эффективность</th>
                                </tr>
                            </thead>
                            <tbody id="accounts-table">
                                <tr><td colspan="8" class="text-center">Загрузка...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Последние сообщения -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fa fa-comments"></i> Последние сообщения</h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    <div id="messages-list">
                        <div class="text-center text-muted">Загрузка...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SERVER_URL = 'http://188.137.253.169:3000'; // Ваш IP сервера
        let licenseKey = localStorage.getItem('ladabot_license');
        let refreshInterval;

        // Проверяем авторизацию при загрузке
        window.onload = function() {
            if (licenseKey) {
                document.getElementById('license-input').value = licenseKey;
                loadDashboard();
            }
        };

        // Вход
        async function login() {
            licenseKey = document.getElementById('license-input').value.trim();
            const errorEl = document.getElementById('login-error');

            if (!licenseKey) {
                showError('Введите license key');
                return;
            }

            try {
                const response = await fetch(`${SERVER_URL}/api/dashboard/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ license_key: licenseKey })
                });

                const data = await response.json();

                if (data.success) {
                    localStorage.setItem('ladabot_license', licenseKey);
                    document.getElementById('auth-container').classList.add('d-none');
                    document.getElementById('dashboard-container').classList.remove('d-none');
                    document.getElementById('current-license').textContent = licenseKey;
                    loadStats();
                    startAutoRefresh();
                } else {
                    showError(data.error || 'Ошибка авторизации');
                }
            } catch (error) {
                showError('Ошибка подключения к серверу');
            }
        }

        // Загрузка статистики
        async function loadStats() {
            try {
                // Загружаем общую статистику
                const statsResponse = await fetch(`${SERVER_URL}/api/dashboard/stats?license_key=${licenseKey}`);
                const statsData = await statsResponse.json();

                if (statsData.success) {
                    // Общая статистика
                    document.getElementById('stat-accounts').textContent = 
                        statsData.summary.total_accounts || 0;
                    document.getElementById('stat-messages').textContent = 
                        statsData.summary.sent_messages || 0;
                    document.getElementById('stat-responses').textContent = 
                        statsData.summary.received_messages || 0;
                    
                    // Конверсия
                    const sent = statsData.summary.sent_messages || 0;
                    const received = statsData.summary.received_messages || 0;
                    const conversion = sent > 0 ? Math.round((received / sent) * 100) : 0;
                    document.getElementById('stat-conversion').textContent = conversion + '%';

                    // Загружаем аккаунты
                    const accountsResponse = await fetch(`${SERVER_URL}/api/dashboard/accounts?license_key=${licenseKey}`);
                    const accountsData = await accountsResponse.json();
                    
                    if (accountsData.success) {
                        renderAccounts(accountsData.accounts);
                    }

                    // Загружаем сообщения
                    const messagesResponse = await fetch(`${SERVER_URL}/api/dashboard/messages?license_key=${licenseKey}&limit=20`);
                    const messagesData = await messagesResponse.json();
                    
                    if (messagesData.success) {
                        renderMessages(messagesData.messages);
                    }
                } else {
                    showError(statsData.error || 'Ошибка загрузки данных');
                }
            } catch (error) {
                showError('Ошибка подключения: ' + error.message);
            }
        }

        // Рендер аккаунтов
        function renderAccounts(accounts) {
            const tbody = document.getElementById('accounts-table');
            
            if (!accounts || accounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">Нет данных об аккаунтах</td></tr>';
                return;
            }

            let html = '';
            accounts.forEach(acc => {
                const statusClass = acc.status === 'active' ? 'bg-success' : 
                                   acc.status === 'paused' ? 'bg-warning' : 'bg-danger';
                
                html += `
                <tr>
                    <td><small>${acc.id || 'N/A'}</small></td>
                    <td>${acc.login || 'N/A'}</td>
                    <td><span class="badge ${statusClass}">${acc.status || 'unknown'}</span></td>
                    <td><span class="badge bg-info">${acc.mode || 'N/A'}</span></td>
                    <td><span class="badge bg-secondary">${acc.target || 'N/A'}</span></td>
                    <td>${acc.messages_sent || 0}</td>
                    <td>${acc.messages_received || 0}</td>
                    <td>${acc.efficiency || 0}%</td>
                </tr>`;
            });

            tbody.innerHTML = html;
        }

        // Рендер сообщений
        function renderMessages(messages) {
            const container = document.getElementById('messages-list');
            
            if (!messages || messages.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">Сообщений нет</div>';
                return;
            }

            let html = '';
            messages.forEach(msg => {
                const typeIcon = msg.type === 'outgoing' ? 'fa-paper-plane text-primary' : 'fa-reply text-success';
                const typeText = msg.type === 'outgoing' ? 'Отправлено' : 'Получено';
                const time = new Date(msg.timestamp).toLocaleTimeString();
                
                html += `
                <div class="border-start border-${msg.type === 'outgoing' ? 'primary' : 'success'} ps-3 mb-3">
                    <div class="d-flex justify-content-between small text-muted">
                        <div>
                            <i class="fa ${typeIcon} me-1"></i>
                            ${typeText} • ${msg.account?.login || msg.account_id}
                        </div>
                        <div>${time}</div>
                    </div>
                    <div class="mt-1">
                        <strong>Кому:</strong> ${msg.recipient_name || msg.recipient_id}
                    </div>
                    <div class="small mt-1 text-truncate">${msg.content_preview || 'Сообщение'}</div>
                </div>`;
            });

            container.innerHTML = html;
        }

        // Автообновление
        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(loadStats, 30000); // Каждые 30 секунд
        }

        // Выход
        function logout() {
            localStorage.removeItem('ladabot_license');
            location.reload();
        }

        // Показать ошибку
        function showError(message) {
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = message;
            errorEl.classList.remove('d-none');
        }

        // Показать панель
        function loadDashboard() {
            document.getElementById('auth-container').classList.add('d-none');
            document.getElementById('dashboard-container').classList.remove('d-none');
            document.getElementById('current-license').textContent = licenseKey;
            loadStats();
            startAutoRefresh();
        }
    </script>
</body>
</html>