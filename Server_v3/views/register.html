<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель управления ботом</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .navbar-brand { font-weight: 700; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .online-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .bot-online { background-color: #28a745; }
        .bot-offline { background-color: #dc3545; }
        .message-outgoing { border-left: 4px solid #007bff; }
        .message-incoming { border-left: 4px solid #28a745; }
        .error-critical { background-color: #f8d7da; }
        .error-warning { background-color: #fff3cd; }
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fa fa-robot"></i> Панель управления Ladabot
            </a>
            <div class="navbar-text text-light ms-auto" id="current-user">
                Загрузка...
            </div>
            <button class="btn btn-outline-light btn-sm ms-3" onclick="logout()">
                <i class="fa fa-sign-out"></i> Выйти
            </button>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Авторизация -->
        <div id="auth-container" class="row justify-content-center" style="display: none;">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fa fa-sign-in"></i> Вход в панель управления</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Логин</label>
                            <input type="text" id="login-input" class="form-control" placeholder="Введите логин">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Пароль</label>
                            <input type="password" id="password-input" class="form-control" placeholder="Введите пароль">
                        </div>
                        <button class="btn btn-primary w-100" onclick="performLogin()">
                            <i class="fa fa-sign-in"></i> Войти
                        </button>
                        <div class="text-danger small mt-2 text-center" id="login-error"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Основная панель -->
        <div id="main-container" style="display: none;">
            <!-- Статистика -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stat-card bg-primary text-white">
                        <div class="card-body">
                            <h6 class="card-title">Активных ботов</h6>
                            <h2 id="stat-bots" class="mb-0">0</h2>
                            <small><i class="fa fa-robot"></i> онлайн</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card bg-success text-white">
                        <div class="card-body">
                            <h6 class="card-title">Сообщений сегодня</h6>
                            <h2 id="stat-messages" class="mb-0">0</h2>
                            <small><i class="fa fa-envelope"></i> отправлено</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card bg-info text-white">
                        <div class="card-body">
                            <h6 class="card-title">Ответов сегодня</h6>
                            <h2 id="stat-responses" class="mb-0">0</h2>
                            <small><i class="fa fa-reply"></i> получено</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card bg-warning text-white">
                        <div class="card-body">
                            <h6 class="card-title">Конверсия</h6>
                            <h2 id="stat-conversion" class="mb-0">0%</h2>
                            <small><i class="fa fa-percentage"></i> эффективность</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Графики -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fa fa-chart-line"></i> Активность за 7 дней</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fa fa-pie-chart"></i> Распределение по целям</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="targetsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Активные боты -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fa fa-list"></i> Активные боты и анкеты</h6>
                            <button class="btn btn-sm btn-primary" onclick="refreshData()">
                                <i class="fa fa-refresh"></i> Обновить
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Бот ID</th>
                                            <th>Анкета</th>
                                            <th>Режим</th>
                                            <th>Цель</th>
                                            <th>Статус</th>
                                            <th>Отправлено</th>
                                            <th>Ответов</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bots-table">
                                        <tr>
                                            <td colspan="8" class="text-center">Загрузка данных...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Последние сообщения -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fa fa-comments"></i> Последние сообщения</h6>
                        </div>
                        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                            <div id="recent-messages">
                                <div class="text-center text-muted">Загрузка...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ошибки -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fa fa-exclamation-triangle"></i> Последние ошибки</h6>
                            <button class="btn btn-sm btn-success" onclick="markAllErrorsResolved()">
                                <i class="fa fa-check"></i> Исправить все
                            </button>
                        </div>
                        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                            <div id="recent-errors">
                                <div class="text-center text-muted">Загрузка...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно управления ботом -->
    <div class="modal fade" id="botControlModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Управление ботом</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="controlledBotId">
                    <div class="mb-3">
                        <label class="form-label">Команда</label>
                        <select class="form-select" id="commandSelect">
                            <option value="start_bot">Запустить бота</option>
                            <option value="stop_bot">Остановить бота</option>
                            <option value="update_settings">Изменить настройки</option>
                            <option value="change_template">Изменить шаблон</option>
                        </select>
                    </div>
                    <div id="settings-container" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Цель</label>
                            <select class="form-select" id="targetSelect">
                                <option value="online">Online</option>
                                <option value="payers">Payers</option>
                                <option value="my-favorites">My favorites</option>
                                <option value="favorites">Favorites</option>
                                <option value="inbox">Inbox</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Скорость</label>
                            <select class="form-select" id="speedSelect">
                                <option value="smart">Smart</option>
                                <option value="15">15 секунд</option>
                                <option value="30">30 секунд</option>
                                <option value="60">1 минута</option>
                            </select>
                        </div>
                    </div>
                    <div id="template-container" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Новый текст шаблона</label>
                            <textarea class="form-control" id="newTemplate" rows="4" placeholder="Введите новый текст..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="sendBotCommand()">Отправить команду</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const SERVER_URL = 'http://188.137.253.169:3000';
        let sessionId = localStorage.getItem('bot_session_id');
        let charts = {};
        let refreshInterval;

        // Проверка авторизации при загрузке
        window.onload = function() {
            if (sessionId) {
                checkSession();
            } else {
                showAuth();
            }
        };

        // Показать форму авторизации
        function showAuth() {
            document.getElementById('auth-container').style.display = 'block';
            document.getElementById('main-container').style.display = 'none';
        }

        // Показать основную панель
        function showMain() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            loadDashboard();
            startAutoRefresh();
        }

        // Проверка сессии
        async function checkSession() {
            try {
                const response = await fetch(`${SERVER_URL}/api/dashboard`, {
                    headers: { 'X-Session-Id': sessionId }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('current-user').innerText = `Оператор: ${data.operatorName || 'Администратор'}`;
                    showMain();
                } else {
                    localStorage.removeItem('bot_session_id');
                    showAuth();
                }
            } catch (error) {
                console.error('Ошибка проверки сессии:', error);
                showAuth();
            }
        }

        // Вход
        async function performLogin() {
            const login = document.getElementById('login-input').value;
            const password = document.getElementById('password-input').value;
            const errorEl = document.getElementById('login-error');

            if (!login || !password) {
                errorEl.innerText = 'Заполните все поля';
                return;
            }

            try {
                const response = await fetch(`${SERVER_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ login, password })
                });

                const data = await response.json();

                if (response.ok) {
                    sessionId = data.sessionId;
                    localStorage.setItem('bot_session_id', sessionId);
                    document.getElementById('current-user').innerText = `Оператор: ${data.operator.name}`;
                    showMain();
                } else {
                    errorEl.innerText = data.error || 'Ошибка входа';
                }
            } catch (error) {
                errorEl.innerText = 'Ошибка подключения к серверу';
            }
        }

        // Выход
        function logout() {
            localStorage.removeItem('bot_session_id');
            sessionId = null;
            if (refreshInterval) clearInterval(refreshInterval);
            showAuth();
        }

        // Загрузка данных
        async function loadDashboard() {
            try {
                const response = await fetch(`${SERVER_URL}/api/dashboard`, {
                    headers: { 'X-Session-Id': sessionId }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                        return;
                    }
                    throw new Error('Ошибка загрузки данных');
                }

                const data = await response.json();

                // Общая статистика
                document.getElementById('stat-bots').innerText = data.overview.totalBots;
                document.getElementById('stat-messages').innerText = data.overview.messagesToday;
                document.getElementById('stat-responses').innerText = data.overview.responsesToday;
                document.getElementById('stat-conversion').innerText = data.overview.conversionRate + '%';

                // Таблица ботов
                renderBotsTable(data.activeBots || []);

                // Последние сообщения
                renderMessages(data.recentMessages || []);

                // Ошибки
                renderErrors(data.recentErrors || []);

                // Графики (упрощённо)
                updateCharts(data);

            } catch (error) {
                console.error('Ошибка загрузки дашборда:', error);
                alert('Не удалось загрузить данные. Проверьте подключение.');
            }
        }

        // Рендер таблицы ботов
        function renderBotsTable(bots) {
            const tbody = document.getElementById('bots-table');
            if (bots.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">Нет активных ботов</td></tr>';
                return;
            }

            let html = '';
            bots.forEach(bot => {
                const statusClass = bot.status === 'online' ? 'bot-online' : 'bot-offline';
                const statusText = bot.status === 'online' ? 'Онлайн' : 'Офлайн';
                
                html += `
                <tr>
                    <td>
                        <span class="online-dot ${statusClass} me-2"></span>
                        ${bot.id}
                    </td>
                    <td>${bot.display_id || 'N/A'}</td>
                    <td><span class="badge bg-info">${bot.mode || 'mail'}</span></td>
                    <td><span class="badge bg-secondary">${bot.target || 'online'}</span></td>
                    <td>
                        <span class="badge ${bot.status === 'online' ? 'bg-success' : 'bg-danger'}">
                            ${statusText}
                        </span>
                    </td>
                    <td>${bot.messages_sent || 0}</td>
                    <td>${bot.responses_received || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="openBotControl('${bot.id}')">
                            <i class="fa fa-cog"></i> Управлять
                        </button>
                    </td>
                </tr>`;
            });

            tbody.innerHTML = html;
        }

        // Рендер сообщений
        function renderMessages(messages) {
            const container = document.getElementById('recent-messages');
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">Сообщений нет</div>';
                return;
            }

            let html = '';
            messages.forEach(msg => {
                const typeClass = msg.type === 'outgoing' ? 'message-outgoing' : 'message-incoming';
                const typeIcon = msg.type === 'outgoing' ? 'fa-paper-plane text-primary' : 'fa-reply text-success';
                const time = new Date(msg.timestamp).toLocaleTimeString();
                
                html += `
                <div class="border rounded p-3 mb-2 ${typeClass}">
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">
                            <i class="fa ${typeIcon} me-1"></i>
                            ${msg.type === 'outgoing' ? 'Отправлено' : 'Получено'}
                        </small>
                        <small class="text-muted">${time}</small>
                    </div>
                    <div class="mt-1">
                        <strong>${msg.recipient_name || 'ID: ' + msg.recipient_id}</strong>
                    </div>
                    <div class="small text-truncate mt-1">${msg.content_preview || 'Нет текста'}</div>
                </div>`;
            });

            container.innerHTML = html;
        }

        // Рендер ошибок
        function renderErrors(errors) {
            const container = document.getElementById('recent-errors');
            
            if (errors.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">Ошибок нет</div>';
                return;
            }

            let html = '';
            errors.forEach(error => {
                const isCritical = error.error_type && error.error_type.includes('critical');
                const errorClass = isCritical ? 'error-critical' : 'error-warning';
                const time = new Date(error.timestamp).toLocaleTimeString();
                
                html += `
                <div class="border rounded p-3 mb-2 ${errorClass}">
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">
                            <i class="fa fa-exclamation-circle me-1"></i>
                            ${error.error_type || 'Ошибка'}
                        </small>
                        <small class="text-muted">${time}</small>
                    </div>
                    <div class="mt-1">
                        <strong>Бот: ${error.bot_id}</strong>
                    </div>
                    <div class="small mt-1">${error.error_message || 'Неизвестная ошибка'}</div>
                    <button class="btn btn-sm btn-success mt-2" onclick="markErrorResolved(${error.id})">
                        <i class="fa fa-check"></i> Исправлено
                    </button>
                </div>`;
            });

            container.innerHTML = html;
        }

        // Обновление графиков
        function updateCharts(data) {
            // Упрощённая реализация графиков
            // В реальном проекте используйте Chart.js с реальными данными
            console.log('Данные для графиков:', data);
        }

        // Открыть модальное окно управления
        function openBotControl(botId) {
            document.getElementById('controlledBotId').value = botId;
            document.getElementById('modalTitle').innerText = `Управление ботом ${botId}`;
            
            const modal = new bootstrap.Modal(document.getElementById('botControlModal'));
            modal.show();
            
            // Сброс форм
            document.getElementById('settings-container').style.display = 'none';
            document.getElementById('template-container').style.display = 'none';
        }

        // Отправить команду боту
        async function sendBotCommand() {
            const botId = document.getElementById('controlledBotId').value;
            const commandType = document.getElementById('commandSelect').value;
            let parameters = {};

            if (commandType === 'update_settings') {
                parameters = {
                    botId: botId,
                    settings: {
                        target: document.getElementById('targetSelect').value,
                        speed: document.getElementById('speedSelect').value
                    }
                };
            } else if (commandType === 'change_template') {
                parameters = {
                    botId: botId,
                    template: document.getElementById('newTemplate').value
                };
            } else {
                parameters = { botId: botId };
            }

            try {
                const response = await fetch(`${SERVER_URL}/api/create_command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({
                        botId: botId,
                        commandType: commandType,
                        parameters: parameters
                    })
                });

                if (response.ok) {
                    alert('Команда отправлена боту!');
                    bootstrap.Modal.getInstance(document.getElementById('botControlModal')).hide();
                } else {
                    const error = await response.json();
                    alert('Ошибка: ' + (error.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                alert('Ошибка отправки команды: ' + error.message);
            }
        }

        // Отметить ошибку как исправленную
        async function markErrorResolved(errorId) {
            // Реализуйте API для отметки ошибок
            console.log('Отметить ошибку как исправленную:', errorId);
            alert('Функция в разработке');
        }

        // Отметить все ошибки как исправленные
        function markAllErrorsResolved() {
            if (confirm('Отметить все ошибки как исправленные?')) {
                // Реализуйте API
                alert('Функция в разработке');
            }
        }

        // Автообновление
        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(loadDashboard, 30000); // Каждые 30 секунд
        }

        // Ручное обновление
        function refreshData() {
            loadDashboard();
        }

        // Обработка изменения команды
        document.getElementById('commandSelect').addEventListener('change', function() {
            const command = this.value;
            document.getElementById('settings-container').style.display = 
                command === 'update_settings' ? 'block' : 'none';
            document.getElementById('template-container').style.display = 
                command === 'change_template' ? 'block' : 'none';
        });
    </script>
</body>
</html>