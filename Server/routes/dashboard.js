/**
 * Dashboard Routes
 * –ú–∞—Ä—à—Ä—É—Ç—ã –¥–∞—à–±–æ—Ä–¥–∞
 *
 * –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:
 * - GET / - –û—Å–Ω–æ–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
 */

const express = require('express');
const pool = require('../config/database');
const { asyncHandler, buildRoleFilter } = require('../utils/helpers');

const router = express.Router();

/**
 * GET /api/dashboard
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—É—é —Å–≤–æ–¥–∫—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–∞—à–±–æ—Ä–¥–∞
 *
 * @query {string} userId - ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @query {string} role - –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (translator/admin/director)
 * @query {string} dateFrom - –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ (YYYY-MM-DD)
 * @query {string} dateTo - –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ (YYYY-MM-DD)
 * @returns {Object} dashboard - –û–±—ä–µ–∫—Ç —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
 */
router.get('/', asyncHandler(async (req, res) => {
    const { userId, role, dateFrom, dateTo } = req.query;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–∏–æ–¥ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    // –ï—Å–ª–∏ –¥–∞—Ç—ã –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
    const now = new Date();
    const defaultDateFrom = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    const defaultDateTo = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];

    const periodFrom = dateFrom || defaultDateFrom;
    const periodTo = dateTo || defaultDateTo;

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
    const profileRoleFilter = buildRoleFilter(role, userId, { table: 'profiles', prefix: 'WHERE' });
    const activityRoleFilter = buildRoleFilter(role, userId, { table: 'activity', prefix: 'AND' });
    const profileFilter = profileRoleFilter.filter;
    const activityFilter = activityRoleFilter.filter;
    const params = profileRoleFilter.params; // –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ params –¥–ª—è –æ–±–æ–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–∞—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è userId
    const hasUserParam = params.length > 0;
    const dateParamStart = hasUserParam ? 2 : 1;
    const paramsWithDates = hasUserParam ? [params[0], periodFrom, periodTo] : [periodFrom, periodTo];

    /**
     * –ó–∞–ø—Ä–æ—Å 1: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–Ω–∫–µ—Ç
     * –ü—Ä–æ—Å—Ç–æ–π COUNT –ø–æ —Ç–∞–±–ª–∏—Ü–µ allowed_profiles —Å —É—á—ë—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Ä–æ–ª–∏
     */
    const profilesQuery = `
        SELECT COUNT(*) as total_profiles
        FROM allowed_profiles p
        ${profileFilter}
    `;
    const profilesResult = await pool.query(profilesQuery, params);
    const totalProfiles = parseInt(profilesResult.rows[0]?.total_profiles) || 0;

    /**
     * –ó–∞–ø—Ä–æ—Å 2: –û–Ω–ª–∞–π–Ω –∞–Ω–∫–µ—Ç—ã
     * –°—á–∏—Ç–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∞–Ω–∫–µ—Ç—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö –±—ã–ª heartbeat –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –º–∏–Ω—É—Ç—ã.
     */
    const onlineQuery = `
        SELECT COUNT(DISTINCT h.account_display_id) as online_count
        FROM heartbeats h
        JOIN allowed_profiles p ON h.account_display_id = p.profile_id
        WHERE h.timestamp > NOW() - INTERVAL '2 minutes'
        ${profileFilter ? profileFilter.replace('WHERE', 'AND') : ''}
    `;
    const onlineResult = await pool.query(onlineQuery, params);
    const profilesOnline = parseInt(onlineResult.rows[0]?.online_count) || 0;

    /**
     * –ó–∞–ø—Ä–æ—Å 3: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ AI –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
     */
    let aiQuery, aiParams;
    if (hasUserParam) {
        aiQuery = `
            SELECT
                COUNT(*) FILTER (WHERE used_ai = true) as ai_count,
                COUNT(*) as total_count
            FROM activity_log a
            WHERE a.created_at >= $2::date
              AND a.created_at < ($3::date + interval '1 day')
              ${activityFilter}
        `;
        aiParams = paramsWithDates;
    } else {
        aiQuery = `
            SELECT
                COUNT(*) FILTER (WHERE used_ai = true) as ai_count,
                COUNT(*) as total_count
            FROM activity_log a
            WHERE a.created_at >= $1::date
              AND a.created_at < ($2::date + interval '1 day')
        `;
        aiParams = [periodFrom, periodTo];
    }
    const aiResult = await pool.query(aiQuery, aiParams);
    const aiStats = aiResult.rows[0] || {};

    /**
     * –ó–∞–ø—Ä–æ—Å 4: –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
     */
    let statsQuery, statsParams;
    if (hasUserParam) {
        statsQuery = `
            SELECT
                COALESCE(COUNT(*) FILTER (WHERE a.action_type = 'letter'), 0) as letters_count,
                COALESCE(COUNT(*) FILTER (WHERE a.action_type = 'chat'), 0) as chats_count,
                COUNT(DISTINCT a.man_id) as unique_men,
                COALESCE(AVG(a.response_time_sec), 0) as avg_response_seconds,
                COALESCE(PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY a.response_time_sec), 0) as median_response_seconds
            FROM activity_log a
            WHERE a.created_at >= $2::date
              AND a.created_at < ($3::date + interval '1 day')
              ${activityFilter}
        `;
        statsParams = paramsWithDates;
    } else {
        statsQuery = `
            SELECT
                COALESCE(COUNT(*) FILTER (WHERE a.action_type = 'letter'), 0) as letters_count,
                COALESCE(COUNT(*) FILTER (WHERE a.action_type = 'chat'), 0) as chats_count,
                COUNT(DISTINCT a.man_id) as unique_men,
                COALESCE(AVG(a.response_time_sec), 0) as avg_response_seconds,
                COALESCE(PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY a.response_time_sec), 0) as median_response_seconds
            FROM activity_log a
            WHERE a.created_at >= $1::date
              AND a.created_at < ($2::date + interval '1 day')
        `;
        statsParams = [periodFrom, periodTo];
    }
    const statsResult = await pool.query(statsQuery, statsParams);
    const stats = statsResult.rows[0] || {};

    /**
     * –ó–∞–ø—Ä–æ—Å 5: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
     */
    const errorsQuery = `
        SELECT COUNT(*) as errors_count
        FROM error_logs
        WHERE timestamp >= $1::date AND timestamp < ($2::date + interval '1 day')
    `;
    const errorsResult = await pool.query(errorsQuery, [periodFrom, periodTo]);
    const errors = errorsResult.rows[0] || {};

    /**
     * –ó–∞–ø—Ä–æ—Å 6: –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –º—É–∂—á–∏–Ω –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
     */
    let incomingWhereClause = '';
    let incomingParams = [periodFrom, periodTo];

    if (role === 'translator' && userId) {
        incomingWhereClause = `AND i.translator_id = $3`;
        incomingParams.push(userId);
    } else if (role === 'admin' && userId) {
        incomingWhereClause = `AND i.admin_id = $3`;
        incomingParams.push(userId);
    }

    const incomingQuery = `
        SELECT
            COALESCE(COUNT(*) FILTER (WHERE i.type = 'letter'), 0) as incoming_letters,
            COALESCE(COUNT(*) FILTER (WHERE i.type = 'chat'), 0) as incoming_chats,
            COALESCE(COUNT(*) FILTER (WHERE i.is_first_from_man = true), 0) as unique_men
        FROM incoming_messages i
        WHERE i.created_at >= $1::date
          AND i.created_at < ($2::date + interval '1 day')
          ${incomingWhereClause}
    `;

    // DEBUG: –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –≤—Ö–æ–¥—è—â–∏—Ö
    console.log('üìä DEBUG incoming_messages:');
    console.log('   Query params:', incomingParams);
    console.log('   Role:', role, 'UserId:', userId);
    console.log('   Period:', periodFrom, '-', periodTo);

    // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–º —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ
    const totalIncoming = await pool.query('SELECT COUNT(*) as total FROM incoming_messages');
    console.log('   Total records in incoming_messages:', totalIncoming.rows[0].total);

    // –ò –ø—Ä–æ–≤–µ—Ä–∏–º –∑–∞–ø–∏—Å–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∞—Ç–∞–º
    const recentIncoming = await pool.query(`
        SELECT type, COUNT(*) as cnt, MIN(created_at) as min_date, MAX(created_at) as max_date
        FROM incoming_messages
        GROUP BY type
    `);
    console.log('   Records by type:', JSON.stringify(recentIncoming.rows));

    const incomingResult = await pool.query(incomingQuery, incomingParams);
    const incoming = incomingResult.rows[0] || {};

    console.log('   Query result:', JSON.stringify(incoming));

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
    const lettersCount = parseInt(stats.letters_count) || 0;
    const chatsCount = parseInt(stats.chats_count) || 0;
    const uniqueMenCount = parseInt(stats.unique_men) || 0;
    const avgResponseSec = parseFloat(stats.avg_response_seconds) || 0;
    const medianResponseSec = parseFloat(stats.median_response_seconds) || 0;
    const incomingLettersCount = parseInt(incoming.incoming_letters) || 0;
    const incomingChatsCount = parseInt(incoming.incoming_chats) || 0;
    const incomingUniqueMen = parseInt(incoming.unique_men) || 0;
    const errorsCount = parseInt(errors.errors_count) || 0;

    // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
    res.json({
        success: true,
        dashboard: {
            // –ü–µ—Ä–∏–æ–¥ –∑–∞ –∫–æ—Ç–æ—Ä—ã–π –¥–∞–Ω–Ω—ã–µ
            period: {
                from: periodFrom,
                to: periodTo
            },
            // –î–∞–Ω–Ω—ã–µ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (–Ω–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
            letters: lettersCount,
            chats: chatsCount,
            incomingLetters: incomingLettersCount,
            incomingChats: incomingChatsCount,
            uniqueMen: incomingUniqueMen,
            errors: errorsCount,
            // –ú–µ—Ç—Ä–∏–∫–∏
            metrics: {
                totalProfiles: totalProfiles,
                profilesOnline: profilesOnline,
                avgResponseTime: Math.round(avgResponseSec / 60),
                medianResponseTime: Math.round(medianResponseSec / 60)
            },
            // AI —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            ai: {
                count: parseInt(aiStats.ai_count) || 0,
                total: parseInt(aiStats.total_count) || 0,
                percent: aiStats.total_count > 0
                    ? Math.round((aiStats.ai_count / aiStats.total_count) * 100)
                    : 0
            },
            // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            today: {
                letters: lettersCount,
                chats: chatsCount,
                incomingLetters: incomingLettersCount,
                incomingChats: incomingChatsCount,
                uniqueMen: incomingUniqueMen,
                errors: errorsCount
            },
            yesterday: {
                letters: 0,
                chats: 0,
                incomingLetters: 0,
                incomingChats: 0
            },
            week: {
                letters: lettersCount,
                chats: chatsCount,
                incomingLetters: incomingLettersCount,
                incomingChats: incomingChatsCount,
                uniqueMen: incomingUniqueMen,
                errors: errorsCount
            },
            month: {
                letters: lettersCount,
                chats: chatsCount,
                incomingLetters: incomingLettersCount,
                incomingChats: incomingChatsCount,
                uniqueMen: incomingUniqueMen
            }
        }
    });
}));

module.exports = router;
